<% correction ||= nil %>

<%= turbo_frame_tag dom_id(message) do %>
  <%= content_tag :div, id: dom_id(message), class: 'group py-4' do %>
    <div class="flex">
      <div class="mr-4 shrink-0">
        <%= render 'components/avatar', size: :xs %>
      </div>
      <div class="space-y-2 grow-1 w-full">
        <div class="flex justify-between items-baseline">
          <div class="font-medium text-sm text-tertiary-900 flex items-center">
            <%= message_sender(message) %>
            <span class="text-xs text-tertiary-500 font-normal ml-1"><%= message_timestamp(message, current_user.time_zone) %></span>
            <% if message.correction %>
              <span class="text-xs text-success-600 font-normal flex ml-4">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 shrink-0 mr-1">
                  <path fill-rule="evenodd" d="M16.403 12.652a3 3 0 000-5.304 3 3 0 00-3.75-3.751 3 3 0 00-5.305 0 3 3 0 00-3.751 3.75 3 3 0 000 5.305 3 3 0 003.75 3.751 3 3 0 005.305 0 3 3 0 003.751-3.75zm-2.546-4.46a.75.75 0 00-1.214-.883l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                </svg>
                Corrected response
              </span>
            <% end %>
          </div>
        </div>
        
        <% if correction %>
          <div class="rounded p-2 bg-white border border-info-200 mt-2">
            <% if correction.persisted? %>
              <%= render 'corrections/form', correction: correction %>
            <% else %>
              <%= render 'messages/corrections/form', correction: correction, message: message %>
            <% end %>
          </div>
        <% else %>
          <div class="text-tertiary-600 leading-relaxed font-normal">
            <%= message.correction ? message.correction.response : message.content %>
          </div>
        <% end %>
      </div>
      <% if (message.sent_by_account?(current_account) || message.ai_generated?) && message.feedback.nil? %>
        <div class="ml-2 shrink-0 invisible group-hover:visible">
          <%= render 'feedback/feedback', message: message %>
        </div>
      <% end %>
    </div>
    <% if message.feedback %>
      <div class="pl-10 mt-4">
        <%= render 'feedback/existing_feedback', feedback: message.feedback %>
      </div>
    <% end %>
  <% end %>
<% end %>